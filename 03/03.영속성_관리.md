# 3. 영속성 관리

## 3.1 엔티티 매니저 팩토리 & 엔티티 매니저

* EntityManagerFactory: 고 비용, 어플리케이션 전체에서 1개만 만들어서 공유, thread-safe
* EntityManager: 비교적 저비용, 필요할 때 마다 생성, non thread-safe



EntityManager 는 DB 연결이 꼭 필요한 시점까지 커넥션을 하지 않고, Transaction 을 시작할 때 등에 커넥션을 획득한다.



<br>



## 3.2 영속성 컨텍스트

영속성 컨텍스트란 엔티티를 영구 저장하는 환경이란 뜻이다.

엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

영속성 컨텍스트는 엔티티 매니저를 생성 시 하나가 생성된다.



<br>



## 3.3 엔티티의 생명주기

* 비영속(new): 영속성 컨텍스트와 무관계 상태
  * 엔티티 객체를 막 생성한 순수한 객체 상태. 영속성 컨텍스트나 DB 와는 전혀 연관없음
* 영속(managed): 영속성 컨텍스트에 저장된 상태
  * 엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장하여 영속성 컨텍스트가 관리하는 상태
* 준영속(detached): 영속성 컨텍스트에 저장되어있다가 분리된 상태
  * 영속 상태였단 엔티티를 더 이상 영속성 컨텍스트가 관리하지 않게 된 상태
* 삭제(removed): 삭제된 상태
  * 엔티티를 영속성 컨텍스트 및 DB 에서 삭제



<br>



## 3.4 영속성 컨텍스트 특징

* 영속성 컨텍스트는 Entity 를 식별자 값(`@Id` 테이블의 PK 와 매핑한 값)으로 구분하기 때문에 영속 상태는 식별자 값이 반드시 필요
* 트랜잭션을 커밋하는 순간 flush 를 하여 영속성 컨텍스트에 새로 저장된 Entity 를 DB 에 반영함
* 영속성 컨텍스트가 엔티티를 관리할 시의 장점
  * 1차 캐시
    * 영속 상태의 엔티티가 모두 저장되는 영속성 컨텍스트 내부의 캐시
    * 키는 `@Id` 로 매핑한 식별자, 값은 Entity instance
    * `entityManager.find()` 호출 시 1차 캐시에서 엔티티를 우선 찾고, 없으면 DB 조회
  * 동일성 보장
    * 조회 시 1차 캐시에서 우선 조회하기 때문에 반복 호출 시에도 영속성 컨텍스트는 동일 인스턴스를 반환할 수 있음
  * 트랜잭션을 지원하는 쓰기지연
    * EntityManager 는 트랜잭션을 커밋하기 전 까지 DB 에 엔티티를 저장하지 않고, 내부 쿼리 저장소에 SQL 을 쌓아둠
    * 트랜잭션을 커밋 시 모아둔 쿼리를 DB 로 보내는데 이것을 트랜잭션을 지원하는 쓰기지연이라 함
  * 변경 감지
  * 지연 로딩
* 